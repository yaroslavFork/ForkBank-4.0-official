<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ForkBank 4.0 </title>
    <style>
        body { background: #050a10; color: white; font-family: sans-serif; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .app-container { width: 100%; max-width: 400px; margin-top: 10px; }
        .card { background: #101825; padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #1d2b41; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: none; background: #000; color: white; box-sizing: border-box; text-align: center; font-size: 16px; }
        button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 10px; background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.1s; }
        button:active { transform: scale(0.98); }
        .balance-box { font-size: 42px; color: #00ffcc; margin: 5px 0; font-weight: bold; text-shadow: 0 0 15px rgba(0,255,204,0.3); }
        .status-vip { color: gold !important; font-weight: bold; }
        #admin-btn { position: fixed; bottom: 20px; right: 20px; background: gold; color: black; border-radius: 50%; width: 55px; height: 55px; font-size: 24px; font-weight: bold; display: none; z-index: 1000; border: none; cursor:pointer; }
        .hidden { display: none !important; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 350px; background: #1c2536; border: 2px solid gold; border-radius: 20px; z-index: 2000; padding: 20px; text-align: center; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1500; }
        .registry-box { background: #0a0f18; border: 1px solid #1d2b41; border-radius: 10px; margin: 20px 0 10px 0; padding: 10px; max-height: 100px; overflow-y: auto; text-align: left; }
        .registry-item { font-size: 11px; color: #aaa; padding: 3px 0; border-bottom: 1px solid #161d29; display: flex; justify-content: space-between; }
        .admin-list-container { background: #000; border-radius: 10px; padding: 10px; max-height: 200px; overflow-y: auto; text-align: left; margin-top: 10px; font-family: monospace; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="screen-login" class="card">
        <h1 style="color:#007bff;">ForkBank 4.0</h1>
        <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="userpass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button id="login-btn">–í–û–ô–¢–ò</button>
    </div>

    <div id="screen-main" class="card hidden">
        <div id="user-info" style="color:#888; font-size: 14px; margin-bottom: 10px;"></div>
        <div class="balance-box"><span id="balance">0</span> D</div>
        
        <div class="clicker-section" style="margin-top:10px; background:#161d29; padding:15px; border-radius:15px; border:1px solid #007bff;">
            <button id="click-btn">–ö–õ–ò–ö (+10 D)</button>
            <div id="piggy-val" style="color:gold; font-size:28px; margin:5px; font-weight:bold;">0 D</div>
            <button id="withdraw-btn" style="background:#6f42c1;">–í–´–í–ï–°–¢–ò –í –ë–ê–ù–ö</button>
        </div>

        <input type="text" id="promo-input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥">
        <button id="apply-promo-btn" style="background:#6f42c1;">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨</button>

        <div class="registry-box">
            <div id="ui-registry-list">...</div>
        </div>

        <button id="send-btn" style="background:#28a745;">üí∏ –ü–ï–†–ï–í–û–î</button>
        <button id="access-btn" style="opacity:0;">.</button>
        <button id="logout-btn" style="background:#222; font-size:12px;">–í–´–ô–¢–ò</button>
    </div>
</div>

<button id="admin-btn">–ü</button>

<div id="modal-admin" class="modal">
    <h2 style="color:gold; margin-bottom:10px;">–ü–†–ï–ó–ò–î–ï–ù–¢</h2>
    <button id="adm-list-btn" style="background:#17a2b8;">üìä –†–ï–ï–°–¢–† –ò –ë–ê–õ–ê–ù–°–´</button>
    <div id="admin-users-list" class="admin-list-container hidden"></div>
    <button id="adm-promo-btn" style="background:#28a745;">üéÅ –°–û–ó–î–ê–¢–¨ –ü–†–û–ú–û</button>
    <button id="adm-status-btn">üëë –ò–ó–ú–ï–ù–ò–¢–¨ –°–¢–ê–¢–£–°</button>
    <button id="adm-edit">üí∞ –ò–ó–ú–ï–ù–ò–¢–¨ –ë–ê–õ–ê–ù–°</button>
    <button id="adm-del-btn" style="background:#dc3545;">‚ùå –£–î–ê–õ–ò–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
    <button onclick="closeModals()" style="background:#222; margin-top:10px;">–ó–ê–ö–†–´–¢–¨</button>
</div>
<div id="overlay" onclick="closeModals()"></div>

<script type="module">
    import { Client, Databases, ID, Query } from "https://cdn.jsdelivr.net/npm/appwrite@13.0.1/+esm";
    const client = new Client().setEndpoint('https://cloud.appwrite.io/v1').setProject('695f9aae003cc43e58d4');
    const databases = new Databases(client);
    const DB = '695f9bbc00302230a3eb', COL = 'users';

    const app = {
        user: null, allUsers: [], piggy: 0, lastActionTime: 0,

        async init() {
            window.closeModals = () => { 
                document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); 
                document.getElementById('overlay').style.display='none'; 
                document.getElementById('admin-users-list').classList.add('hidden');
            };
            document.getElementById('login-btn').onclick = () => this.login();
            document.getElementById('click-btn').onclick = () => { if(this.user.status!=='banned'){this.piggy += 10; document.getElementById('piggy-val').innerText = this.piggy + " D";} };
            document.getElementById('withdraw-btn').onclick = () => this.withdrawPiggy();
            document.getElementById('apply-promo-btn').onclick = () => this.applyPromo();
            document.getElementById('send-btn').onclick = () => this.sendMoney();
            
            document.getElementById('access-btn').onclick = () => { if(prompt("–ö–û–î:")==="VYA_chsv") document.getElementById('admin-btn').style.display='block'; };
            document.getElementById('admin-btn').onclick = () => { document.getElementById('modal-admin').style.display='block'; document.getElementById('overlay').style.display='block'; };
            
            document.getElementById('adm-list-btn').onclick = () => this.toggleAdminList();
            document.getElementById('adm-promo-btn').onclick = () => this.createPromo();
            document.getElementById('adm-status-btn').onclick = () => this.adminSetStatus();
            document.getElementById('adm-edit').onclick = () => this.adminEdit();
            document.getElementById('adm-del-btn').onclick = () => this.adminDelete();
            
            document.getElementById('logout-btn').onclick = () => { localStorage.clear(); location.reload(); };

            const saved = localStorage.getItem('fork_session');
            if (saved) { const {n,p}=JSON.parse(saved); this.login(n,p,true); }
        },

        async sync(newBal) {
            this.lastActionTime = Date.now();
            this.user.balance = Math.floor(newBal);
            document.getElementById('balance').innerText = this.user.balance;
            await databases.updateDocument(DB, COL, this.user.$id, { balance: this.user.balance });
        },

        async createPromo() {
            const code = prompt("–ö–æ–¥:"); const val = prompt("–°—É–º–º–∞:");
            if(code && val) {
                await databases.createDocument(DB, COL, ID.unique(), {
                    name: "PROMO_" + code, passworld: "SYS", balance: parseInt(val), user_id: 0, status: 'promo'
                });
                alert("–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω!");
            }
        },

        async applyPromo() {
            const input = document.getElementById('promo-input').value.trim();
            const res = await databases.listDocuments(DB, COL, [Query.equal("name", "PROMO_" + input)]);
            if(res.documents.length > 0) {
                const doc = res.documents[0];
                await databases.deleteDocument(DB, COL, doc.$id);
                await this.sync(Number(this.user.balance) + doc.balance);
                alert("–£—Å–ø–µ—à–Ω–æ!");
                document.getElementById('promo-input').value = "";
            } else alert("–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        },

        async login(n, p, isAuto) {
            try {
                const res = await databases.listDocuments(DB, COL, [Query.equal("name", n)]);
                if(res.documents.length > 0) {
                    this.user = res.documents[0];
                    if(this.user.passworld !== p) return;
                    if(this.user.status === 'banned') return alert("–í–´ –ó–ê–ë–ê–ù–ï–ù–´");
                    document.getElementById('screen-login').classList.add('hidden');
                    document.getElementById('screen-main').classList.remove('hidden');
                    await this.refreshData();
                    setInterval(() => { if(Date.now() - this.lastActionTime > 15000) this.refreshData(); }, 10000);
                } else if(!isAuto) {
                    this.user = await databases.createDocument(DB, COL, ID.unique(), {
                        name: n, passworld: p, balance: 100, user_id: Math.floor(Math.random()*900)+100, status: 'user'
                    });
                    location.reload();
                }
                localStorage.setItem('fork_session', JSON.stringify({n, p}));
            } catch(e) {}
        },

        async refreshData() {
            const res = await databases.listDocuments(DB, COL);
            this.allUsers = res.documents.filter(u => u.status !== 'promo');
            document.getElementById('ui-registry-list').innerHTML = this.allUsers.map(u => `<div class="registry-item">${u.name} <span>ID: ${u.user_id}</span></div>`).join('');
            const fresh = this.allUsers.find(u => u.$id === this.user.$id);
            if(fresh) {
                if(Number(fresh.balance) >= Number(this.user.balance)) this.user.balance = fresh.balance;
                this.user.status = fresh.status;
                document.getElementById('balance').innerText = this.user.balance;
                document.getElementById('user-info').innerHTML = `<span class="${this.user.status==='vip'?'status-vip':''}">${this.user.status==='vip'?'üëë ':''}${this.user.name}</span> (ID: ${this.user.user_id})`;
            }
        },

        toggleAdminList() {
            const list = document.getElementById('admin-users-list');
            list.classList.toggle('hidden');
            list.innerHTML = this.allUsers.map(u => `<div style="font-size:11px; border-bottom:1px solid #222; padding:4px;">ID:${u.user_id} | <b>${u.name}</b> | ${u.balance} D | ${u.status}</div>`).join('');
        },

        async adminSetStatus() {
            const id = prompt("ID –∏–≥—Ä–æ–∫–∞:");
            const target = this.allUsers.find(u => u.user_id == id);
            if(target) {
                const s = prompt("1-User, 2-VIP, 3-Ban");
                const finalS = s==='2'?'vip':s==='3'?'banned':'user';
                await databases.updateDocument(DB, COL, target.$id, { status: finalS });
                alert("–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!");
                this.refreshData();
            }
        },

        async adminEdit() {
            const id = prompt("ID:"); const v = parseInt(prompt("–°—É–º–º–∞ (+/-):"));
            const t = this.allUsers.find(u => u.user_id == id);
            if(t) { await databases.updateDocument(DB, COL, t.$id, { balance: t.balance + v }); alert("–ë–∞–ª–∞–Ω—Å –∏–∑–º–µ–Ω–µ–Ω!"); this.refreshData(); }
        },

        async adminDelete() {
            const id = prompt("ID –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:");
            const t = this.allUsers.find(u => u.user_id == id);
            if(t && confirm("–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞ " + t.name + " –Ω–∞–≤—Å–µ–≥–¥–∞?")) {
                await databases.deleteDocument(DB, COL, t.$id);
                alert("–£–¥–∞–ª–µ–Ω–æ!");
                this.refreshData();
            }
        },

        async withdrawPiggy() {
            if(!this.piggy) return;
            const amt = this.piggy; this.piggy = 0;
            document.getElementById('piggy-val').innerText = "0 D";
            await this.sync(Number(this.user.balance) + amt);
        },

        async sendMoney() {
            const tid = prompt("ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è:"); const amt = parseInt(prompt("–°—É–º–º–∞:"));
            const target = this.allUsers.find(u => u.user_id == tid);
            if(!target || amt > this.user.balance || amt <= 0) return alert("–û—à–∏–±–∫–∞!");
            const fee = (this.user.status==='vip' || target.status==='vip') ? 0 : Math.floor(amt*0.1);
            await databases.updateDocument(DB, COL, this.user.$id, { balance: this.user.balance - amt });
            await databases.updateDocument(DB, COL, target.$id, { balance: target.balance + (amt-fee) });
            await this.sync(this.user.balance - amt);
            alert("–ì–æ—Ç–æ–≤–æ!");
        }
    };
    app.init();
</script>
</body>
</html>
